<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/fragments/header :: mainHeader}"><!-- 부트 스트랩 -->
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<body>

    <form method="post" action="/member/helperRegister" id="form">
        <!--회원아이디-->
        <input type="hidden" name="memberId" th:value="${session.user.id}" />
        경력사항 1 <input type="text" name="goodAtFirst" /> <br />
        경력사항 2<input type="text" name="goodAtSecond" /> <br />
        경력사항 3<input type="text" name="goodAtThird" /> <br />
        각오 <textarea name="appeal" rows="5" ></textarea> <br />

        <input type="hidden" name="img" id="img">
        <input name="uploadFiles" type="file"  multiple />
         <button type="button" class="uploadBtn" >upload</button>
        <div class="uploadResult">

        </div>
        <button type="submit">헬퍼가입신청</button>
     </form>


<script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<script>
    $('.uploadBtn').click(function(){

        var formData = new FormData();
        var inputFile = $("input[type='file']");
        var files = inputFile[0].files;

        for(var i = 0; i<files.length; i++){
            console.log(files[i]);
            formData.append("uploadFiles", files[i]);
        }

        //실제 업로드 부분
        //upload ajax
        $.ajax({
            url: '/uploadAjax',
            processData: false,
            contentType: false,
            data:formData,
            type:'POST',
            dataType:'json',
            success:function(result){
                console.log(result);
                showUploadImages(result);
                make_Hidden(result);

            },
            error:function(jqXHR, textStatus, errorThrown){
                console.log(textStatus);
            }

        });//ajax

    });

    //Ajax업로드 이후 이미지 호출
    function showUploadImages(arr){
        console.log(arr);
        var divArea = $(".uploadResult");
        var str = "";

        for(var i = 0; i < arr.length; i++){
            str += "<div class='imgUpload'"+i+ ">";
            str +="<img src='/display?fileName="+arr[i].thumbnailURL+"'>";
            str +="<button class='removeBtn' data-name='"+arr[i].imageURL+"'>REMOVE</button>"
            str +="</div>";

        }
        divArea.append(str);
    }

    function make_Hidden(arr){
        var temp="";
        for(var i=0; i<arr.length; i++){
            temp+="<img src='/display?fileName="+arr[i].thumbnailURL+"'>*";
            $('#img').val(temp);

        }

    }

    //이미지파일 삭제
    $(".uploadResult").on("click",".removeBtn",function(e){

        var target = $(this);
        var fileName = target.data("name");
        var targetDiv = $(this).closest("div");

        console.log(fileName);

        $.post('/removeFile',{fileName:fileName}, function(result){
            console.log(result);
            if(result===true){
                targetDiv.remove();
            }
        })
    });
</script>


</body>
</html>